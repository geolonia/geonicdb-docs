---
title: 空間ID / ZFXY
description: Vela OS はデジタル庁 / IPA の 3D 空間識別標準（ZFXY）を実装し、3次元空間グリッドでエンティティのインデックスとクエリを行えます。
outline: deep
---

# 空間ID / ZFXY

Vela OS は、日本の**デジタル庁**および **IPA**（情報処理推進機構）が定める **3D 空間識別標準**（通称 **ZFXY** または**空間ID**）を実装しています。これにより、階層的な3D空間グリッドシステムを使ってエンティティのインデックスとクエリが可能です。

## ZFXY とは

ZFXY は、Google マップや OpenStreetMap 等で使われる2Dウェブ地図タイリングを **高さ（フロア）軸** を追加して3次元に拡張した空間識別スキームです。各空間セルは4つのパラメータで識別されます:

| パラメータ | 説明 | 範囲 |
|-----------|------|------|
| **z** | ズームレベル（空間解像度） | 0–28 |
| **f** | フロアレベル（垂直/高度インデックス） | 任意の整数（負数可） |
| **x** | X タイル座標（経度方向） | 0 ～ 2^z − 1 |
| **y** | Y タイル座標（緯度方向） | 0 ～ 2^z − 1 |

### フォーマット

```text
z/f/x/y
```

先頭スラッシュ付き:

```text
/z/f/x/y
```

**例**: `20/0/929593/410773` はズームレベル20、地上レベルの東京付近のタイルを識別します。

## 仕組み

### 水平グリッド（X, Y）

水平グリッドは **Web Mercator** タイリングスキームに準拠:

- ズームレベル0: 世界全体が1タイル（1×1）
- ズームレベル1: 世界が4タイルに分割（2×2）
- ズームレベルz: 世界は 2^z × 2^z タイル
- 高いズームレベルほど空間解像度が細かくなる

### 垂直グリッド（F）

フロアパラメータで垂直方向を追加:

- **f = 0**: 地上レベル
- **f > 0**: 地上階（各フロアは高度範囲に対応）
- **f < 0**: 地下（地下構造物、地下鉄等）

高度の解像度はズームレベルに依存します。デフォルト設定（基準ズーム25、1メートル/ユニット）の場合:

- ズームレベル25: 各フロア = 1メートル
- ズームレベル20: 各フロア = 32メートル
- ズームレベル15: 各フロア = 1,024メートル

## API での使用

### 空間IDでクエリ

特定の空間セル内のエンティティをクエリ:

```bash
curl "https://api.vela.geolonia.com/v2/entities?spatialId=20/0/929593/410773" \
  -H "Authorization: Bearer YOUR_API_KEY"
```

### 深度展開付きクエリ

より細かいズームレベルの子タイルを含めてクエリを展開:

```bash
curl "https://api.vela.geolonia.com/v2/entities?spatialId=18/0/232398/102693&depth=2" \
  -H "Authorization: Bearer YOUR_API_KEY"
```

`depth=2` の場合、ズームレベル18の親タイル内に含まれるズームレベル20の全タイルのエンティティを返します。

## 空間ID 操作

Vela の空間IDシステムは以下の操作をサポートします:

### 座標から空間IDへの変換

地理座標を指定ズームレベルの空間IDに変換:

- **入力**: 経度、緯度、高度（オプション）、ズームレベル
- **出力**: `z/f/x/y` 形式の空間ID
- **投影法**: Web Mercator（EPSG:3857）

### 空間IDからバウンディングボックスへの変換

空間IDを地理的な境界に逆変換:

- **2D**: 経度・緯度の最小/最大値を返却
- **3D**: フロアレベルに基づく高度の最小/最大値も含む

### 階層操作

- **展開**: より深いズームレベルの子タイルをすべて取得（例: ズーム18 → ズーム20で4タイル）
- **親取得**: より浅いズームレベルの親タイルを取得
- **包含判定**: 座標が空間IDの境界内にあるか判定
- **バウンディングボックスから空間IDへ**: 指定バウンディングボックスをカバーする全空間IDを取得

## 空間IDによるジオフェンシング

空間IDは階層的な空間インデックスを提供することで効率的なジオフェンシングを実現します:

1. 特定ズームレベルの空間ID群で**ジオフェンスを定義**
2. データ取り込み時にエンティティを空間IDで**インデックス化**
3. **効率的にクエリ** — すべてのエンティティに対してポイントインポリゴン計算を行う代わりに、空間IDプレフィックスのマッチングで処理

これは数百万のエンティティを定義された地理的エリア内で監視する必要があるスマートシティアプリケーションで特に有用です。

## 参考資料

- [デジタル庁 — 空間ID](https://www.digital.go.jp/policies/mobility_and_infrastructure/spatial-id)
- [IPA — 4次元時空間ガイドライン](https://www.ipa.go.jp/digital/architecture/guidelines/4dspatio-temporal-guideline.html)

## 次のステップ

- [CADDE](/ja/japan-standards/cadde) — 分野間データ連携基盤との連携
- [スマートシティ事例](/ja/japan-standards/smart-city-cases) — Vela を使ったスマートシティのユースケース
